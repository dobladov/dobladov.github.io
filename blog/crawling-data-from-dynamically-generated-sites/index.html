<!DOCTYPE html><html lang="en" data-astro-cid-colb5upu><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/orb512.png"><meta name="generator" content="Astro v3.0.9"><link rel="manifest" href="/manifest.webmanifest"><meta http-equiv="content-language" content="en"><link rel="alternate" type="application/rss+xml" title="RSS feed" href="/rss.xml"><link rel="alternate" type="application/feed+json" title="JSON feed" href="/feed.json"><!-- Canonical URL --><link rel="canonical" href="https://dobla.do/blog/crawling-data-from-dynamically-generated-sites/"><link rel="sitemap" href="/sitemap-index.xml"><!-- Primary Meta Tags --><title>Crawling data from dynamically generated sites - Daniel Doblado</title><meta name="title" content="Crawling data from dynamically generated sites"><meta name="description" content="How to get data from other sites using free online services"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://dobla.do/blog/crawling-data-from-dynamically-generated-sites/"><meta property="og:title" content="Crawling data from dynamically generated sites"><meta property="og:description" content="How to get data from other sites using free online services"><meta property="og:image" content="https://dobla.do/orb512.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://dobla.do/blog/crawling-data-from-dynamically-generated-sites/"><meta property="twitter:title" content="Crawling data from dynamically generated sites"><meta property="twitter:description" content="How to get data from other sites using free online services"><meta property="twitter:image" content="https://dobla.do/orb512.png"><style type="text/css">article{margin:0 auto;max-width:46rem}article p{margin-bottom:2em}@media screen and (min-width: 468px){article{margin-top:2rem}}.toArticle{position:fixed;top:-100%;left:50%;transform:translate(-50%);transition:top .3s ease-in-out;padding:0 1rem}.toArticle:focus{top:1%}#title{text-align:left}.date{text-align:right;font-style:italic}.description{font-size:2rem;line-height:110%;text-align:center}@keyframes adjust-progressbar{0%{height:0}to{height:100%}}aside:before,aside:after{content:"";position:absolute;top:0;left:0;width:.25rem;height:100%;background:var(--text);border-radius:.25rem}@supports (animation-timeline: scroll(block root)){aside:after{background:var(--accent);animation:adjust-progressbar;animation-timeline:scroll(block root);animation-duration:auto}}aside{display:none;position:fixed;left:1rem;top:50%;max-width:15rem;transform:translateY(-50%);max-height:50vh;padding-left:1rem;padding-right:1rem}aside ul{list-style:none;margin:0;padding:0}aside a{text-overflow:ellipsis;display:inline-block;text-decoration:none;transition:transform .2s ease-out;transform-origin:left;line-height:1;padding-bottom:.5rem;color:var(--text)}aside a.active{color:var(--accent)}aside a:hover{transform:scale(1.1);color:var(--accent)}pre{margin-bottom:2rem}@media screen and (min-width: 992px){img,pre{--space: 8rem;width:calc(100% + var(--space));position:relative;left:calc(var(--space) / -2);max-width:calc(100% + var(--space))!important}#title{--space: 5rem;width:calc(100% + var(--space));position:relative;left:calc(var(--space) / -2);font-size:4rem}}@media screen and (min-width: 1300px){aside{display:block}}summary{cursor:pointer}.details{font-family:Courier New,monospace;padding-top:1rem}#metadata{display:flex;flex-direction:column;justify-content:space-between;font-size:.8rem}.tags{display:flex;flex-wrap:wrap;column-gap:.5rem;justify-content:flex-end}.metaSection{gap:1.5rem;display:flex;justify-content:space-between;border-top:1px solid var(--text);padding-top:.2rem;padding-bottom:.2rem}.centered{padding-top:1rem}.correctLink{margin-top:1.5rem}@media print{article{max-width:210mm;width:210mm}.toArticle,.date,.correctLink,details{display:none}}
:root{--background: #18181b;--accent: #fafafa;--text: rgb(161, 161, 170);--link: tomato;--paddingSides: 2rem}html{scroll-behavior:smooth;scrollbar-gutter:stable}body{font-family:Trebuchet MS,sans-serif;margin:0;padding:0;text-align:left;word-wrap:break-word;overflow-wrap:break-word;color:var(--text);line-height:1.7;background-color:var(--background);display:flex;flex-direction:column;min-height:100vh}::selection{color:var(--accent);background:var(--link)}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;line-height:1.2;color:var(--accent)}h1{font-size:2.5em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{color:var(--accent);font-weight:700}a{color:var(--accent);position:relative;text-decoration:none;background:linear-gradient(0deg,var(--link),var(--link)) no-repeat right bottom / 0 var(--bg-h);transition:background-size .35s;--bg-h: 100%;padding-bottom:2px;--bg-h: 2px}a:hover{background-size:100% var(--bg-h);background-position-x:left}p{margin-bottom:1em;color:var(--text)}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;border-radius:2px;color:#9ecbff;border:1px solid #9ecbff;background:#24292f}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(229,233,240)}.centered{text-align:center}@media screen and (min-width: 468px){body{--paddingSides: 4rem}h1{font-size:3.052em}}@media print{*{-webkit-transition:none!important;transition:none!important}body{--background: white;--text: black;--accent: charcoal}}a[data-astro-cid-eimmu3lg]{color:var(--text)}a[data-astro-cid-eimmu3lg].active{color:var(--accent);transform:scale(1.01);text-decoration-color:var(--accent)}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 calc(var(--paddingSides) / 2);padding-top:1rem;z-index:1}h1[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{color:var(--accent);text-decoration:none}h1[data-astro-cid-3ef6ksr2]{margin:0;font-size:3em;text-align:center;font-weight:100}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between;flex-direction:column;gap:1.5rem;align-items:stretch}.internalLinks[data-astro-cid-3ef6ksr2]{font-size:1.3em;display:flex;justify-content:center;align-items:center;gap:.8rem}@media screen and (min-width: 768px){h1[data-astro-cid-3ef6ksr2]{font-size:3em}nav[data-astro-cid-3ef6ksr2]{flex-direction:row}.internalLinks[data-astro-cid-3ef6ksr2]{flex-wrap:wrap}}svg[data-astro-cid-3ef6ksr2]{width:1rem;fill:var(--text)}@media print{header[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{flex-wrap:wrap;padding-left:var(--paddingSides);padding-right:var(--paddingSides);padding-bottom:2rem;display:flex;justify-content:space-evenly;align-items:center;gap:1em;font-size:1.3rem;font-weight:600;z-index:2;text-shadow:1px 1px 1px var(--background)}@media screen and (min-width: 768px){footer[data-astro-cid-sz7xmlte]{justify-content:center}}@media print{footer[data-astro-cid-sz7xmlte]{display:none}}main[data-astro-cid-colb5upu]{flex:1}section[data-astro-cid-colb5upu]{padding-top:2rem;padding-bottom:2rem;padding-left:calc(var(--paddingSides) / 2);padding-right:calc(var(--paddingSides) / 2)}
</style><script type="module" src="/_astro/hoisted.335e4b07.js"></script></head><body data-js="false" data-astro-cid-colb5upu><a class="toArticle" href="#article">To the article</a><header data-astro-cid-3ef6ksr2><nav data-astro-cid-3ef6ksr2><h1 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Daniel Doblado</a></h1><div class="internalLinks" data-astro-cid-3ef6ksr2><a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Blog</a><a href="/projects" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Projects</a><a href="/tags" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Tags</a><a href="/rss.xml" title="RSS" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg><svg xml:space="preserve" viewBox="0 0 82.459 82.347" data-astro-cid-3ef6ksr2 astro-icon="rss"><g transform="translate(-10.112 -9.668)"><circle cx="21.243" cy="80.884" r="11.131"/><path d="M18.229 40.126a7.626 7.626 0 1 0 0 15.253c15.917 0 28.865 12.95 28.865 28.865a7.626 7.626 0 0 0 7.628 7.627 7.627 7.627 0 0 0 7.627-7.627c0-24.326-19.793-44.118-44.12-44.118z"/><path d="M17.997 9.668a7.628 7.628 0 0 0 0 15.254c32.708.001 59.32 26.613 59.32 59.322a7.627 7.627 0 1 0 15.254 0c0-41.118-33.453-74.573-74.574-74.576z"/></g></svg></a><!-- <ThemeToggle /> --></div></nav></header><main data-astro-cid-colb5upu><section data-astro-cid-colb5upu><article id="article"><header><h1 id="title">Crawling data from dynamically generated sites</h1><div class="date">11 min read — <time datetime="2020-02-14T00:00:00.000Z">Feb 14, 2020</time></div></header><aside><ul><li><a title="Navigate to the start of the article" href="#title">Start</a></li><li><a href="#parsing-the-site">Parsing the site</a></li><li><a href="#using-glitch">Using Glitch</a></li><li><a href="#using-zeitco">Using Zeit.co</a></li><li><a href="#notes">Notes</a></li><li><a id="metadataLink" title="Navigate to the end of the article" href="#metadata">Metadata</a></li></ul></aside><p class="description">How to get data from other sites using free online services</p><p>Let’s start with the need, why I had the necessity to do this,
Recently I created this <a href="https://observablehq.com/@dobladov/coronavirus-2019-ncov" rel="nofollow" target="_blank">Corona Virus Map</a>, I wanted to be the fastest getting the data from the source site in Chinese, most of the other sites get the data periodical using a cron task and dumping their data locally.</p>
<p>In my case I wanted to get their data every time the map is loaded, ensuring more accurate results and completely avoiding any manual update of data.</p>
<h2 id="parsing-the-site">Parsing the site<a aria-hidden="true" tabindex="-1" href="#parsing-the-site"><span class="icon icon-link"></span></a></h2>
<p>So my first try was to curl the page and sadly the results for this <a href="https://ncov.dxy.cn/ncovh5/view/pneumonia" rel="nofollow" target="_blank">site</a> will not load unless you use Javascript since the tables are dynamically generated.</p>
<p>This leave us with not many options but to use a browser, so in my case I decided to use Puppeteer, a headless Chrome browser to get the data.</p>
<p>So after a while playing with it I got the code to do it, it will download and log the data in the format that I need.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">fs</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'fs'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">puppeteer</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'puppeteer'</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">(</span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">browser</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> puppeteer.</span><span style="color: #B392F0">launch</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">page</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> browser.</span><span style="color: #B392F0">newPage</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> page.</span><span style="color: #B392F0">goto</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'https://ncov.dxy.cn/ncovh5/view/pneumonia'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">data</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> page.</span><span style="color: #B392F0">evaluate</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">body</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    [</span><span style="color: #F97583">...</span><span style="color: #E1E4E8">document.</span><span style="color: #B392F0">querySelectorAll</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">".close___2yTiY:not(.open___3it7L)"</span><span style="color: #E1E4E8">)].</span><span style="color: #B392F0">forEach</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> e.</span><span style="color: #B392F0">click</span><span style="color: #E1E4E8">())</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> [</span><span style="color: #F97583">...</span><span style="color: #E1E4E8">document.</span><span style="color: #B392F0">querySelectorAll</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'.areaBox___3jZkr'</span><span style="color: #E1E4E8">)[</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">].</span><span style="color: #B392F0">querySelectorAll</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'.areaBlock2___27vn7'</span><span style="color: #E1E4E8">)].</span><span style="color: #B392F0">map</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">row</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> [</span><span style="color: #79B8FF">area</span><span style="color: #E1E4E8">, ,</span><span style="color: #79B8FF">confirmed</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">dead</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">cured</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [</span><span style="color: #F97583">...</span><span style="color: #E1E4E8">row.</span><span style="color: #B392F0">querySelectorAll</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'p'</span><span style="color: #E1E4E8">)]</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">        area: area.innerText,</span></span>
<span class="line"><span style="color: #E1E4E8">        confirmed: </span><span style="color: #F97583">+</span><span style="color: #E1E4E8">confirmed.innerText </span><span style="color: #F97583">||</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        dead: </span><span style="color: #F97583">+</span><span style="color: #E1E4E8">dead.innerText </span><span style="color: #F97583">||</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        cured: </span><span style="color: #F97583">+</span><span style="color: #E1E4E8">cured.innerText </span><span style="color: #F97583">||</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">    })</span></span>
<span class="line"><span style="color: #E1E4E8">  })</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(data)</span></span>
<span class="line"><span style="color: #E1E4E8">  fs.</span><span style="color: #B392F0">writeFileSync</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">`2020-02-16T21:21:26.466Z.json`</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">JSON</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">stringify</span><span style="color: #E1E4E8">(data, </span><span style="color: #79B8FF">null</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">))</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> browser.</span><span style="color: #B392F0">close</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">})()</span></span></code></pre>
<p>After launching this script with <code>node crawler.js</code> I get a file that I can use as the source data of my visualization.</p>
<p>All fine but now I have another need, how to get this data every time I load the map?</p>
<p>For this I definitely need a server running but for this case I wanted to see what can I do with free services.</p>
<h2 id="using-glitch">Using Glitch<a aria-hidden="true" tabindex="-1" href="#using-glitch"><span class="icon icon-link"></span></a></h2>
<p>My first approach was to use <a href="glitch.com">Glitch</a>, after setting a express server and a few tries later I got my data every time I curl this url: <a href="https://coronacrawler.glitch.me" rel="nofollow" target="_blank">https://coronacrawler.glitch.me</a></p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">express</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"express"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">app</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">express</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">puppeteer</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'puppeteer'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">app.</span><span style="color: #B392F0">use</span><span style="color: #E1E4E8">(express.</span><span style="color: #B392F0">static</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"public"</span><span style="color: #E1E4E8">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">app.</span><span style="color: #B392F0">get</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"/"</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">request</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">response</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">try</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">browser</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> puppeteer.</span><span style="color: #B392F0">launch</span><span style="color: #E1E4E8">({</span></span>
<span class="line"><span style="color: #E1E4E8">      args: [</span><span style="color: #9ECBFF">'--no-sandbox'</span><span style="color: #E1E4E8">]</span></span>
<span class="line"><span style="color: #E1E4E8">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">// Same code to get the data before</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    res.</span><span style="color: #B392F0">json</span><span style="color: #E1E4E8">(data)</span></span>
<span class="line"><span style="color: #E1E4E8">  } </span><span style="color: #F97583">catch</span><span style="color: #E1E4E8"> (error) {</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(error)</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">listener</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> app.</span><span style="color: #B392F0">listen</span><span style="color: #E1E4E8">(process.env.</span><span style="color: #79B8FF">PORT</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">function</span><span style="color: #E1E4E8">() {</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Your app is listening on port "</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> listener.</span><span style="color: #B392F0">address</span><span style="color: #E1E4E8">().port)</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span></code></pre>
<p>Cool, but this creates another problem.</p>
<h3 id="cross-origin">Cross-origin<a aria-hidden="true" tabindex="-1" href="#cross-origin"><span class="icon icon-link"></span></a></h3>
<p>The map running in ObservableHQ needs to crawl this data and unfortunately if you curl a different domain from a website it needs to have Cross-origin headers enabled or for security reasons it will not load, after adding this to our express server it works.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">app.</span><span style="color: #B392F0">use</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">function</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">req</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">res</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">next</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">  res.</span><span style="color: #B392F0">header</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Access-Control-Allow-Origin"</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">"*"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  res.</span><span style="color: #B392F0">header</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Access-Control-Allow-Headers"</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">"Origin, X-Requested-With, Content-Type, Accept"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">next</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span></code></pre>
<h4 id="alternative-to-cross-origin">Alternative to Cross-origin<a aria-hidden="true" tabindex="-1" href="#alternative-to-cross-origin"><span class="icon icon-link"></span></a></h4>
<p>Another solution if adding the headers is impossible (For example in a server we can’t control), we can use a service like <a href="https://cors-anywhere.herokuapp.com/" rel="nofollow" target="_blank">cors-anywhere</a>, just changing the URL to be:</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">https://cors-anywhere.herokuapp.com/https://coronacrawler.glitch.me</span></span></code></pre>
<h4 id="problems-with-glitch">Problems with Glitch<a aria-hidden="true" tabindex="-1" href="#problems-with-glitch"><span class="icon icon-link"></span></a></h4>
<p>Nice, now I have a server running and I can query the data, what else can I ask for? Well while this works there are two main problems, Glitch is more of a place for playing with code and experimenting so it will not be fast.</p>
<p>Glitch servers go to sleep, it’s perfectly understandable, it makes no sense for Glitch to give computing power for free running all the time, after some period of inactivity the machine will go to sleep and it needs to be awaken the next time, this makes the map unresponsive if there are not many queries and it gives the sensation of being more slow than it is.</p>
<p>At this point I moved to zeit.co</p>
<h2 id="using-zeitco">Using Zeit.co<a aria-hidden="true" tabindex="-1" href="#using-zeitco"><span class="icon icon-link"></span></a></h2>
<p>Why use zeit.co when Glitch is working?</p>
<p>This service offers quite a nice free “Hobby” service allowing to use serverless functions.</p>
<h3 id="creating-a-serverless-function">Creating a serverless function<a aria-hidden="true" tabindex="-1" href="#creating-a-serverless-function"><span class="icon icon-link"></span></a></h3>
<p>We need to modify the previous script a little since we have other constrains.</p>
<p>First we need a start point for the api query in this case we need a file in <code>/api/index.js</code></p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">getData</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'./getData'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF">module</span><span style="color: #E1E4E8">.</span><span style="color: #79B8FF">exports</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> (</span><span style="color: #FFAB70">req</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">res</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">data</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">getData</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  res.</span><span style="color: #B392F0">json</span><span style="color: #E1E4E8">(data)</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>The first problem I encountered is that using puppeteer is a little bit different, luckily this guide <a href="https://zeit.co/blog/serverless-chrome" rel="nofollow" target="_blank">Serverless Chrome via Puppeteer with Now 2.0</a> explains how to do it well.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">chrome</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'chrome-aws-lambda'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">puppeteer</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'puppeteer-core'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">getData</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">browser</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> puppeteer.</span><span style="color: #B392F0">launch</span><span style="color: #E1E4E8">({</span></span>
<span class="line"><span style="color: #E1E4E8">    args: chrome.args,</span></span>
<span class="line"><span style="color: #E1E4E8">    executablePath: </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> chrome.executablePath,</span></span>
<span class="line"><span style="color: #E1E4E8">    headless: chrome.headless,</span></span>
<span class="line"><span style="color: #E1E4E8">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">page</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> browser.</span><span style="color: #B392F0">newPage</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> page.</span><span style="color: #B392F0">goto</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'https://ncov.dxy.cn/ncovh5/view/pneumonia'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// Same code to get the data before</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> data</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF">module</span><span style="color: #E1E4E8">.</span><span style="color: #79B8FF">exports</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> getData</span></span></code></pre>
<h4 id="supporting-cross-origin">Supporting Cross-origin<a aria-hidden="true" tabindex="-1" href="#supporting-cross-origin"><span class="icon icon-link"></span></a></h4>
<p>To enable cors we need a file <code>/api/200.js</code></p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #79B8FF">module</span><span style="color: #E1E4E8">.</span><span style="color: #79B8FF">exports</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> (</span><span style="color: #FFAB70">req</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">res</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  res.</span><span style="color: #B392F0">status</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">200</span><span style="color: #E1E4E8">).</span><span style="color: #B392F0">send</span><span style="color: #E1E4E8">({ message: </span><span style="color: #9ECBFF">'cors ok'</span><span style="color: #E1E4E8"> });</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>Also our <code>now.js</code> file should look like this.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #9ECBFF">"version"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #9ECBFF">"routes"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #9ECBFF">"src"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"/(.*)"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #9ECBFF">"dest"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"/api/index.js"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #9ECBFF">"headers"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"Access-Control-Allow-Origin"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"*"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"Access-Control-Allow-Methods"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"OPTIONS"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"Access-Control-Allow-Headers"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"Origin, X-Requested-With, Content-Type, Accept, Authorization"</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  ]</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>After this using the command <code>now</code> should upload the project to zeit.co and the data is available on the project url <a href="https://cvirus.dobladov.now.sh/" rel="nofollow" target="_blank">https://cvirus.dobladov.now.sh/</a></p>
<h2 id="notes">Notes<a aria-hidden="true" tabindex="-1" href="#notes"><span class="icon icon-link"></span></a></h2>
<p>As an alternative to Glitch and Zeit we can use <a href="https://docs.netlify.com/functions/overview/#manage-your-serverless-functions" rel="nofollow" target="_blank">Netlify</a>, but for this project it was not necessary.</p>
<p>I’m not affiliated to Glitch of Zeit.co in any way, I just think both are really nice services to run my apps.</p><!-- <Share title={title} description={description} url={href} /> --><details class="details"><summary>Metadata</summary><div id="metadata"><div class="metaSection"><span class="title">Published</span><time datetime="2020-02-14T00:00:00.000Z">Feb 14, 2020</time></div><div class="metaSection"><span class="title">Length</span><span>11 min read (2085 words)</span></div><div class="metaSection"><span class="title">License</span><a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div><div class="metaSection"><span class="title">Tags</span><div class="tags"><a href="/tags/javascript">#javascript</a><a href="/tags/crawler">#crawler</a></div></div><div class="centered"><a class="correctLink" target="_blank" href="https://github.com/dobladov/astro-blog/edit/main/src/content/blog/crawling-data-from-dynamically-generated sites.md">Did I make a mistake? Please consider sending a pull request</a></div><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Crawling data from dynamically generated sites","editor":"Daniel Doblado","genre":"javascript crawler","keywords":"javascript crawler","wordcount":2085,"url":"https://dobla.do/blog/crawling-data-from-dynamically-generated-sites/","datePublished":"2020-02-14T00:00:00.000Z","dateCreated":"2020-02-14T00:00:00.000Z","description":"How to get data from other sites using free online services","author":{"@type":"Person","name":"Daniel Doblado"}}</script></div></details><div class="progress"></div></article></section></main><footer data-astro-cid-sz7xmlte><a target="_blank" href="https://codepen.io/dobladov" data-astro-cid-sz7xmlte>CodePen</a><a target="_blank" href="mailto:danieldoblado@gmail.com" data-astro-cid-sz7xmlte>E-Mail</a><a target="_blank" href="https://github.com/dobladov" data-astro-cid-sz7xmlte>GitHub</a><a target="_blank" href="https://stackoverflow.com/users/2498992/daniel-doblado" data-astro-cid-sz7xmlte>StackOverflow</a><a target="_blank" href="https://mastodon.social/@danieldobla" data-astro-cid-sz7xmlte>Mastodon</a><a target="_blank" href="https://x.com/danieldobla" data-astro-cid-sz7xmlte>𝕏</a></footer></body></html>